---
title: "ENV 790.30 - Time Series Analysis for Energy Data | Spring 2025"
author: "Bella Huang"
subtitle: "Assignment 3 - Due date 02/03/26"
output:
  pdf_document:
    latex_engine: xelatex
    keep_tex: true
header-includes:
  - \usepackage{fontspec}
  - \usepackage{xeCJK}
geometry: margin=2.54cm
editor_options:
  chunk_output_type: console
---

```{r}

```

## Directions

You should open the .rmd file corresponding to this assignment on RStudio. The file is available on our class repository on Github.

Once you have the file open on your local machine the first thing you will do is rename the file such that it includes your first and last name (e.g., "LuanaLima_TSA_A03_Sp25.Rmd"). Then change "Student Name" on line 4 with your name.

Then you will start working through the assignment by **creating code and output** that answer each question. Be sure to use this assignment document. Your report should contain the answer to each question and any plots/tables you obtained (when applicable).

Please keep this R code chunk options for the report. It is easier for us to grade when we can see code and output together. And the tidy.opts will make sure that line breaks on your code chunks are automatically added for better visualization.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,tidy.opts=list(width.cutoff=80), tidy=FALSE) 
```

When you have completed the assignment, **Knit** the text and code into a single PDF file. Submit this pdf using Sakai.

## Questions

Consider the same data you used for A2 from the spreadsheet "Table_10.1_Renewable_Energy_Production_and_Consumption_by_Source.xlsx". The data comes from the US Energy Information and Administration and corresponds to the December 2025 Monthly Energy Review. This time you will work only with the following columns: 
**Total Renewable Energy Production**; and 
**Hydroelectric Power Consumption**.

Create a data frame structure with these two time series only.

R packages needed for this assignment:"forecast","tseries", and "Kendall". Install these packages, if you haven't done yet. Do not forget to load them before running your script, since they are NOT default packages.\\

```{r}
#Load/install required package here
library(forecast)
library(tseries)
library(dplyr)
library(Kendall)
library(readxl)
library(openxlsx)
library(ggplot2)
library(cowplot)
```

```{r}
#Importing data set
getwd()
energy_data1 <- read_excel(path="../Data/Table_10.1_Renewable_Energy_Production_and_Consumption_by_Source.xlsx",skip = 12, sheet="Monthly Data",col_names=FALSE) 

read_col_names <- read_excel(path="../Data/Table_10.1_Renewable_Energy_Production_and_Consumption_by_Source.xlsx",skip = 10,n_max = 1, sheet="Monthly Data",col_names=FALSE) 

colnames(energy_data1) <- read_col_names

energy_data_processed <- energy_data1 %>%
select("Month",
"Total Renewable Energy Production",
"Hydroelectric Power Consumption") %>%
mutate(Month = as.Date(Month, format = "%Y/%m/%d"))
summary(energy_data_processed)
```

##Trend Component

### Q1

For each series (Total Renewable Production and Hydroelectric Consumption) create three plots arranged in a row (side-by-side): (1) time series plot, (2) ACF, (3) PACF. Use cowplot::plot_grid() to place them in a grid.
```{r}
ts_energy_data <- ts(energy_data_processed[,-1], start=c(1973,1),frequency=12)

# Total Renewable Energy Production
p_ts <- autoplot(ts_energy_data[, "Total Renewable Energy Production"]) +
  geom_hline(yintercept = mean(ts_energy_data[, "Total Renewable Energy Production"], na.rm = TRUE), color = "blue", linetype = "dashed") +
  labs(title = "Total Renewable Energy Production (Monthly)", x = "Year",y = "Energy Production")
p_acf <- forecast::ggAcf(ts_energy_data[, "Total Renewable Energy Production"], lag.max = 40) + labs(title = "ACF")

p_pacf <- forecast::ggPacf(ts_energy_data[, "Total Renewable Energy Production"], lag.max = 40) + labs(title = "PACF")

cowplot::plot_grid(
  p_ts, p_acf, p_pacf,
  nrow = 1,
  align = "h",
  axis = "tb",
  rel_widths = c(2.3, 2, 2))

#Hydroelectric Power Consumption
p_ts2 <- autoplot(ts_energy_data[, "Hydroelectric Power Consumption"]) + 
  geom_hline(yintercept = mean(ts_energy_data[, "Hydroelectric Power Consumption"], na.rm = TRUE), color = "darkgreen", linetype = "dashed") +
  labs(title = "Hydroelectric Power Consumption (Monthly)", x = "Year", y = "Energy Consumption")

p_acf2 <- forecast::ggAcf(ts_energy_data[, "Hydroelectric Power Consumption"], lag.max = 40, plot = TRUE,main = "ACF")

p_pacf2 <- forecast::ggPacf(ts_energy_data[, "Hydroelectric Power Consumption"], lag.max = 40, plot = TRUE,main = "PACF")

cowplot::plot_grid(
  p_ts2, p_acf2, p_pacf2,
  nrow = 1,
  align = "h",
  axis = "tb",    
  rel_widths = c(2.3, 2, 2))
```


### Q2

From the plot in Q1, do the series Total Renewable Energy Production and Hydroelectric Power Consumption appear to have a trend? If yes, what kind of trend?
> Answer: From the plots in Q1, Total Renewable Energy Production clearly exhibits a strong upward trend, with accelerated growth in more recent years. What's more, the ACF remains high with very slow decay, which indicates that this serie is non-stationary one. On the other hand, Hydroelectric Power Consumption fluctuates around a relatively stable mean, with a seasonal factor. In addition, the acf and pacf decays quickly from a high value, indicating that the serie is more likely to be a stationary one without a strong long-term trend.

### Q3

Use the *lm()* function to fit a linear trend to the two time series. Ask R to print the summary of the regression. Interpret the regression output, i.e., slope and intercept. Save the regression coefficients for further analysis.
```{r}

nobs <- nrow(energy_data_processed)
t <- 1:nobs

lm_renew <- lm(
  ts_energy_data[, "Total Renewable Energy Production"] ~ t)
summary(lm_renew)
beta0_renew <- as.numeric(lm_renew$coefficients[1])  # intercept
beta1_renew <- as.numeric(lm_renew$coefficients[2])  # slope

lm_hydro <- lm(
  ts_energy_data[, "Hydroelectric Power Consumption"] ~ t)
summary(lm_hydro)
beta0_hydro <- as.numeric(lm_hydro$coefficients[1])  # intercept
beta1_hydro <- as.numeric(lm_hydro$coefficients[2])  # slope


```
Total Renewable Energy Production:
The slope equals to 0.75, meaning that the total renewable energy production increases on average by about 0.75 units per month. The intercept is 171.45, which means that the estimated level of total renewable energy production when t = 0. Thus, there is a strong and statistically significant(with p-value: < 2.2e-16) upward linear trend over time.
Hydroelectric Power Consumption:
The slope equals to âˆ’0.012, so hydroelectric power consumption decreases by about 0.012 units per month on average. The intercept is 83.22, hydroelectric power consumption is around 83.22 at t = 0. This series has a very slight downward linear trend, but the magnitude of the trend is negligible, and the series largely fluctuates around a stable mean.

### Q4

Use the regression coefficients to detrend each series (subtract fitted linear trend). Plot detrended series and compare with the original time series from Q1. Describe what changed.
```{r}
# detrend using regression coefficients
detrend_renew <- ts_energy_data[, "Total Renewable Energy Production"] - (beta0_renew + beta1_renew * t)
detrend_hydro <- ts_energy_data[, "Hydroelectric Power Consumption"] - (beta0_hydro + beta1_hydro * t)
ts_detrend_renew <- ts(detrend_renew,
                       frequency = 12,
                       start = c(1973, 1))
ts_detrend_hydro <- ts(detrend_hydro,
                       frequency = 12,
                       start = c(1973, 1))
ggplot(energy_data_processed,
       aes(x = t, y = `Total Renewable Energy Production`)) +
  geom_line(color = "blue") +
  geom_abline(intercept = beta0_renew, slope = beta1_renew, color = "red") +
  geom_line(aes(y = detrend_renew), color = "green") +
  geom_smooth(aes(y = detrend_renew), method = "lm",
              color = "orange", se = FALSE) +
  labs(title = "Total Renewable Energy Production: Original vs Detrended", y = "Energy Production")

ggplot(energy_data_processed,
       aes(x = t, y = `Hydroelectric Power Consumption`)) +
  geom_line(color = "blue") +
  geom_abline(intercept = beta0_hydro, slope = beta1_hydro, color = "red") +
  geom_line(aes(y = detrend_hydro), color = "green") +
  geom_smooth(aes(y = detrend_hydro), method = "lm",
              color = "orange", se = FALSE) +
  labs(title = "Hydroelectric Power Consumption: Original vs Detrended", y = "Energy Consumption")

```
Total Renewable Energy Production:
The original series shows a strong, persistent upward trend over time, but detrending successfully removes this strong upward trend. Thus, the a series that is approximately stationary in mean, showing a fluctuation around 0.
Hydroelectric Power Consumption:
The original series fluctuates around a relatively constant level with no obvious long-term trend, and the detrended series still looks very similar to the original. Thus, detrending has minimal impact on hydroelectric power consumption, confirming that this series does not exhibit a strong linear trend.

### Q5

Plot ACF and PACF for the detrended series and compare with the plots from Q1. You may use plot_grid() again to get them side by side to make it easier to compare. Did the plots change? How?
```{r}
# Renew - ACF
p_acf_orig_renew <- ggAcf(ts_energy_data[, "Total Renewable Energy Production"],
  lag.max = 40) + labs(title = "ACF: Original Series")

p_acf_det_renew <- ggAcf(ts_detrend_renew, lag.max = 40) + labs(title = "ACF: Detrended Series")

cowplot::plot_grid(p_acf_orig_renew, p_acf_det_renew, nrow = 1)

# Renew - PACF
p_pacf_orig_renew <- ggPacf(ts_energy_data[, "Total Renewable Energy Production"], lag.max = 40) + labs(title = "PACF: Original Series")

p_pacf_det_renew <- ggPacf(ts_detrend_renew, lag.max = 40) + labs(title = "PACF: Detrended Series")

cowplot::plot_grid(p_pacf_orig_renew, p_pacf_det_renew,nrow = 1)

# Hydro - ACF
p_acf_orig_hydro <- ggAcf( ts_energy_data[, "Hydroelectric Power Consumption"], lag.max = 40) + labs(title = "ACF: Original Series")

p_acf_det_hydro <- ggAcf(ts_detrend_hydro, lag.max = 40) + labs(title = "ACF: Detrended Series")

cowplot::plot_grid(p_acf_orig_hydro, p_acf_det_hydro,nrow = 1)

# Hydro - PACF
p_pacf_orig_hydro <- ggPacf(ts_energy_data[, "Hydroelectric Power Consumption"], lag.max = 40) + labs(title = "PACF: Original Series")

p_pacf_det_hydro <- ggPacf(ts_detrend_hydro,lag.max = 40) + labs(title = "PACF: Detrended Series")

cowplot::plot_grid(p_pacf_orig_hydro, p_pacf_det_hydro, nrow = 1)

```

After detrending, the ACF of the renewable energy series shows reduced autocorrelation and a slower decay. So, part of the non-stationarity in the original series was coming from a deterministic trend. The PACF also shows fewer large spikes and a clearer seasonal effect, but the significant autocorrelation remains, suggesting that seasonality and short-term dependence still exists.

For hydroelectric power consumption, detrending does not change the ACF or PACF by a great amount. The strong seasonal trend remains dominant, with a significant short-term change for both. The series is primarily driven by seasonality rather than a deterministic trend.

## Seasonal Component

Set aside the detrended series and consider the original series again from Q1 to answer Q6 to Q8.

### Q6

Just by looking at the time series and the acf plots, do the series seem to have a seasonal trend? No need to run any code to answer your question. Just type in you answer below.

> Answer: Total Renewable Energy Production shows a dominant long-term upward trend, without any obvious fluctuations. In the ACF, there are small bumps at seasonal lags, but they are relatively weak compared to the overall persistence caused by the trend, suggesting that seasonality is present but not a dominant feature of the series. On the other hand for Hydroelectric Power Consumption, the time series displays a repeating within-year oscillations. In addition, the ACF exhibits some strong spikes at seasonal lags, showing a seasonal behavior. There is a strong annual seasonal pattern in hydroelectric power consumption.

### Q7

Use function *lm()* to fit a seasonal means model (i.e. using the seasonal dummies) to the two time series. Ask R to print the summary of the regression. Interpret the regression output. From the results, which series have a seasonal trend? Do the results match you answer to Q6?
```{r}
dummies_renew <- seasonaldummy(ts_detrend_renew)

seas_means_renew <- lm(detrend_renew ~ dummies_renew)
summary(seas_means_renew)
beta0_renew_seas <- seas_means_renew$coefficients[1]
beta_renew_seas  <- seas_means_renew$coefficients[2:12]

dummies_hydro <- seasonaldummy(ts_detrend_hydro)
seas_means_hydro <- lm(detrend_hydro ~ dummies_hydro)
summary(seas_means_hydro)
beta0_hydro_seas <- seas_means_hydro$coefficients[1]
beta_hydro_seas  <- seas_means_hydro$coefficients[2:12]
```

The results all matches my answer for Q6.
For total renewable energy production, only two of the monthly dummy coefficients are statistically significant. The r-square is less than 5%, indicates that this series does not exhibit a seasonal trend.
Then, for hydroelectric power consumption, almost all monthly dummy coefficients are statistically significant, and the values of the dummy coefficients shows that there are usually high consumption in spring/early summer, and relative low in late summer/fall. The overall p-value is < 2.2e-16, showing that this series has a strong seasonal trend.

### Q8

Use the regression coefficients from Q7 to deseason the series. Plot the deseason series and compare with the plots from part Q1. Did anything change?
```{r}
nobs <- length(detrend_renew)
renew_seas_comp <- numeric(nobs)

for(i in 1:nobs){
  renew_seas_comp[i] <- beta0_renew_seas + beta_renew_seas %*% dummies_renew[i,]
}
hydro_seas_comp <- numeric(nobs)

for(i in 1:nobs){
  hydro_seas_comp[i] <- beta0_hydro_seas + beta_hydro_seas %*% dummies_hydro[i,]
}

# deseason detrended renewable series
deseason_renew <- detrend_renew - renew_seas_comp

# convert to ts object
ts_deseason_renew <- ts(deseason_renew, frequency = 12, start = c(1973, 1))

autoplot(ts_energy_data[, "Total Renewable Energy Production"]) +
  autolayer(ts_deseason_renew,
            series = "Detrended & Deseasoned") +
  ylab("Total Renewable Energy Production") +
  labs(title = "Total Renewable Energy Production: Original vs Detrended & Deseasoned")

# deseason detrended hydro series
deseason_hydro <- detrend_hydro - hydro_seas_comp
# convert to ts object
ts_deseason_hydro <- ts(deseason_hydro, frequency = 12, start = c(1973, 1))

autoplot(ts_energy_data[, "Hydroelectric Power Consumption"]) +
  autolayer(ts_deseason_hydro,
            series = "Detrended & Deseasoned") +
  ylab("Hydroelectric Power Consumption") +
  labs(title = "Hydroelectric Power Consumption: Original vs Detrended & Deseasoned")

```
For total renewable energy production, deseasoning alone does not substantially change the behavior of the series compared to Q1. So, that trend instead of seasonality is the dominant source of non-stationarity for this series.

Deseasoning produces a substantial change for hydroelectric power consumption, and the time plot becomes much flatter. The strong cycle showed in Q1 disappears, and the ACF and PACF no longer contains dominant seasonal lags. It confirms that that seasonality was the main driver of its dependence structure.

### Q9

Plot ACF and PACF for the deseason series and compare with the plots from Q1. You may use plot_grid() again to get them side by side. Did the plots change? How?
```{r}
# Renew - ACF
p_acf_orig_renew <- ggAcf(ts_energy_data[, "Total Renewable Energy Production"],lag.max = 40) + labs(title = "ACF: Original Series")

p_acf_deseason_renew <- ggAcf(ts_deseason_renew, lag.max = 40) + labs(title = "ACF: Deseasoned Series")

cowplot::plot_grid(p_acf_orig_renew, p_acf_deseason_renew, nrow = 1)

# Renew - PACF
p_pacf_orig_renew <- ggPacf(ts_energy_data[, "Total Renewable Energy Production"], lag.max = 40) + labs(title = "PACF: Original Series")

p_pacf_deseason_renew <- ggPacf( ts_deseason_renew, lag.max = 40) + labs(title = "PACF: Deseasoned Series")

cowplot::plot_grid(p_pacf_orig_renew, p_pacf_deseason_renew, nrow = 1)

# Hydro - ACF
p_acf_orig_hydro <- ggAcf(ts_energy_data[, "Hydroelectric Power Consumption"], lag.max = 40) + labs(title = "ACF: Original Series")

p_acf_deseason_hydro <- ggAcf(ts_deseason_hydro, lag.max = 40) + labs(title = "ACF: Deseasoned Series")

cowplot::plot_grid(p_acf_orig_hydro, p_acf_deseason_hydro, nrow = 1)

# Hydro - ACF
p_pacf_orig_hydro <- ggPacf(ts_energy_data[, "Hydroelectric Power Consumption"], lag.max = 40) + labs(title = "PACF: Original Series")

p_pacf_deseason_hydro <- ggPacf(ts_deseason_hydro,lag.max = 40) + labs(title = "PACF: Deseasoned Series")

cowplot::plot_grid(p_pacf_orig_hydro, p_pacf_deseason_hydro, nrow = 1)
```

Compared to the original plots in Q1, deseasoning has little effect on the ACF and PACF of total renewable energy production, as the series remains dominated by a strong trend and slow autocorrelation decay. 

In contrast, deseasoning substantially changes the autocorrelation structure of hydroelectric power consumption by removing some of the dominant seasonal spikes. As a result, the deseasoned hydro series exhibits faster decay and fewer significant lags, indicating that seasonality was the primary source of dependence in the original data.